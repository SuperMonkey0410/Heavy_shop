{% extends "base.html" %}

{% load static %}

{% block title %}Reverence Interlude - Catalog{% endblock title %}

{% block content %}
    <h1 class="rev-head text-uppercase text-center my-4" id="reverence-title">Reverence Interlude - ALL</h1>

    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <h4 class="price-head">Price Range:</h4>
                <div class="price-range d-flex justify-content-between mb-3">
                    <input type="number" name="min_price" id="min_price" class="form-control" placeholder="Min Price" value="{{ request.GET.min_price }}" oninput="debounceApplyFilters()">
                    <input type="number" name="max_price" id="max_price" class="form-control" placeholder="Max Price" value="{{ request.GET.max_price }}" oninput="debounceApplyFilters()">
                </div>

                <h4 class="category-head">Category:</h4>
                {% for category in categories %}
                    <div class="category-option">
                        <input type="checkbox" name="category" id="category-{{ category.slug }}" value="{{ category.slug }}"
                        {% if category.slug in selected_categories %}checked{% endif %} onchange="applyFilters()">
                        <label for="category-{{ category.slug }}" class="d-flex justify-content-between">
                            <div class="category-name">{{ category.name }}</div>
                            <div class="category-len">{{ category.get_item_count }}</div>
                        </label>
                    </div>
                {% endfor %}

                <h4 class="size-head">Size:</h4>
                {% for size in sizes %}
                    <div class="category-option">
                        <input type="checkbox" name="size" id="size-{{ size.name }}" value="{{ size.name }}"
                        {% if size.name in selected_sizes %}checked{% endif %} onchange="applyFilters()">
                        <label for="size-{{ size.name }}">{{ size.name }}</label>
                    </div>
                {% endfor %}
            </div>

            <div class="col-md-9">
                <div class="product-list">
                    <div class="card-container d-flex flex-wrap">
                        {% for product in products %}
                            <div class="col-md-4 mb-4"> <!-- Changed to 4 columns per row on medium screens -->
                                <div class="card h-100">
                                    <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.title }}" title="{{ product.title }}" style="object-fit: cover; height: 200px;">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ product.title }}</h5>
                                     <a href="{% url 'main:product_detail' product.id %}" class="card-link">Подробнее</a>

                                    </div>
                                    <div class="card-footer d-flex justify-content-between">
                                        <div class="product-price">
                                            <b>{{ product.price }}</b><small>₽</small>
                                        </div>
                                        <div class="btn-group" role="group" aria-label="Product actions">
                                            <button type="button" class="btn btn-primary"><i class="fa-regular fa-heart fa-lg"></i></button>
                                            <button type="submit" name="action" value="{{ product.id }}" class="btn btn-primary"><i class="fa-solid fa-cart-shopping"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.category-option input[type="checkbox"]');
            const form = document.getElementById('filter-form');

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    form.submit();
                });
            });
        });

        let timeout;
        function debounceApplyFilters() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const form = document.getElementById('filter-form');
                form.submit();
            }, 1000);
        }

        function applyFilters() {
            const form = document.getElementById('filter-form');
            form.submit();
            updateTitle();
        }

        function updateTitle() {
            const checkboxes = document.querySelectorAll('input[name="category"]:checked');
            const titleElement = document.getElementById('reverence-title');

            if (checkboxes.length > 0) {
                const selectedCategories = Array.from(checkboxes).map(checkbox => {
                    return checkbox.nextElementSibling.textContent.trim();
                });
                titleElement.textContent =   REVERENCE INTERLUDE - ${selectedCategories.join(', ')}  ;
            } else {
                titleElement.textContent = 'REVERENCE INTERLUDE - ALL';
            }
        }

        document.addEventListener('DOMContentLoaded', updateTitle);
    </script>
{% endblock content %}